@page "/login"
@inherits StackBaseComponent
@inject ServiceStackStateProvider provider
@inject ILogger<Login> logger;
@inject NavigationManager NavigationManager;

<div class="container">
    <div class="row">
        <form submit=false class=@ClassNames("col-sm-6", apiResult.IsError ? " was-validated" : "")>
            @if (apiResult.ErrorSummary != null)
            {
                <div class="mb-3 alert alert-danger" role="alert">@apiResult.ErrorSummary</div>
            }

            <div class="mb-3">
                <label for="userName">Email address</label>
                <input type="email" id="userName" placeholder="Enter email" @bind-value="@Email" required
                       class=@ClassNames("form-control", apiResult.InvalidClass(nameof(Authenticate.UserName)))>
                <div class="invalid-feedback">@(apiResult.FieldErrorMessage(nameof(Authenticate.UserName)))</div>
            </div>
            <div class="mb-3">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Password" @bind-value="@Password" required
                       class=@ClassNames("form-control", apiResult.InvalidClass(nameof(Authenticate.Password)))>
                <div class="invalid-feedback">@(apiResult.FieldErrorMessage(nameof(Authenticate.Password)))</div>
            </div>

            <button type="submit" class="mb-3 btn btn-primary" @onclick:preventDefault @onclick="LoginAsync">Login</button>
        </form>

        <div class="mt-4">
            Quick Link:
            <button class="btn btn-secondary" @onclick='e => SetUser("admin@localhost.local", "p@55wOrd")'>admin@localhost.local</button>
        </div>
    </div>
</div>


@code {
    private ApiResult<AuthenticateResponse> apiResult = new();

    private string Email { get; set; } = "";
    private bool EmailValid => !apiResult.HasFieldError(nameof(Authenticate.UserName));

    private string Password { get; set; } = "";
    private bool PasswordValid => !apiResult.HasFieldError(nameof(Authenticate.Password));

    private void SetUser(string email, string password)
    {
        Email = email;
        Password = password;
    }

    private async Task LoginAsync()
    {
        apiResult.Reset();
        var emailEmpty = Email.IsNullOrEmpty();
        var passwordEmpty = Password.IsNullOrEmpty();
        if (emailEmpty)
        {
            apiResult.AddFieldError(nameof(Authenticate.UserName), "Email is required");
        }
        if (passwordEmpty)
        {
            apiResult.AddFieldError(nameof(Authenticate.Password), "Password is required");
        }
        if (emailEmpty || passwordEmpty) return;

        apiResult = await provider.Login(Email, Password);

        if (apiResult.IsSuccess)
        {
            var returnUrl = NavigationManager.QueryString("return");
            if (returnUrl.IsNullOrEmpty())
                returnUrl = "/";
            NavigationManager.NavigateTo(returnUrl!, true);
        }
    }
} 